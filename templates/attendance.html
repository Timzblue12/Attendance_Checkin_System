{% extends "layout.html" %}

{% block title %}Attendance Log{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 20px;">
    <form method="get" action="{{ url_for('attendance_log') }}" class="context-form">
        {% if event_options %}
        <div class="context-item">
            <label for="context_event">Event</label>
            <select id="context_event" name="event_id">
                {% for event in event_options %}
                    <option value="{{ event.id }}" {% if event.id == selected_event_id %}selected{% endif %}>{{ event.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="context-item space">
            <label for="context_date">Session Date</label>
            <input type="date" id="context_date" name="date" value="{{ selected_session_date }}">
        </div>
        {% if session_options and selected_event_id != 'church-service' %}
        <div class="context-item">
            <label for="context_session">Session</label>
            <select id="context_session" name="session_id">
                {% for session in session_options %}
                    <option value="{{ session.id }}" data-period="{{ session.period }}" {% if session.id == selected_session_id %}selected{% endif %}>{{ session.period }} Session</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </form>
</div>

<div style="display: flex; gap: 30px;">

    <div class="card" style="flex: 1;">
        <h3>Check In</h3>
        <p>Assign a temporary tag for today.</p>
        
        <form method="post">
            <div class="check-btn"> <button type="submit" >Check In</button></div>
            
            <input type="hidden" name="action" value="check_in">
            <input type="hidden" name="event_id" value="{{ selected_event_id }}">
            <input type="hidden" name="session_day" value="{{ selected_session_date }}">
            <input type="hidden" name="session_id" value="{{ selected_session_id or '' }}">
            <input type="hidden" name="page" value="{{ attendance_pagination.page if attendance_pagination is defined else 1 }}" data-pagination-sync="attendance">

            <label for="child_name">Child(ren)</label>
            <select id="child_name" name="child_names" style="width: 100%;" multiple required>
                {% for name in children_names %}
                    <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>
            <small class="input-hint">Select one or more siblings to share the same day tag.</small>

            {% if selected_event_id == 'church-service' %}
            <label for="service_type">Service</label>
            <select id="service_type" name="service_type" required>
                <option value="1st Service" {% if service_type_default == '1st Service' %}selected{% endif %}>1st Service</option>
                <option value="2nd Service" {% if service_type_default == '2nd Service' %}selected{% endif %}>2nd Service</option>
            </select>
            {% endif %}

<div class="child-detail-panel">
                <div class="child-detail-head">
                    <div>
                        <p class="detail-label">Selected child</p>
                        <p class="detail-name" id="detail_child_name">Choose a child to view details</p>
                        
                    </div>
                    
                </div>

                <div class="guardian-info" id="guardian_info">
                    <strong>Guardian:</strong> <span id="guardian_name">â€”</span><br>
                    <strong>Phone:</strong> <span id="guardian_phone">â€”</span><br>
                    <strong> <span id="detail_child_class"> â€”</span></strong>
                </div>

                <div class="note-block">
                    <label for="notes">Child note (edit before check-in)</label>
                    <textarea id="notes" name="notes" rows="2" placeholder="Optional notes or reminders"></textarea>
                    <small class="input-hint">Saved note is shown below; you can edit it before submitting.</small>
                </div>

               
            </div>


             <label for="day_tag">Day Tag Number </label>
            <input type="number" id="day_tag" name="day_tag" min="1" max="1000" required style="width: auto;"><br/>

            

            <label for="church_location">Church Location</label>
            <select id="church_location" name="church_location">
                <option value="">-- Select Church Location --</option>
                {% for location in church_locations %}
                    <option value="{{ location }}">{{ location }}</option>
                {% endfor %}
            </select>
           
        </form>
    </div>

    <div class="card" style="flex: 1;">
        <h3>Check Out</h3>
        <p>Enter the tag number to find the children, then confirm checkout.</p>

        <form method="post" class="checkout-form">
            <input type="hidden" name="action" value="find_tag">
            <input type="hidden" name="event_id" value="{{ selected_event_id }}">
            <input type="hidden" name="session_day" value="{{ selected_session_date }}">
            <input type="hidden" name="session_id" value="{{ selected_session_id or '' }}">
            <input type="hidden" name="page" value="{{ attendance_pagination.page if attendance_pagination is defined else 1 }}" data-pagination-sync="attendance">
            {% if selected_event_id == 'church-service' %}
            <input type="hidden" name="service_type" value="{{ service_type_default }}">
            {% endif %}
            <label for="checkout_tag">Tag Number</label>
            <input type="number" id="checkout_tag" name="checkout_tag" value="{{ checkout_tag_value }}" required>
            <button type="submit" class="find-btn">Find</button>
        </form>

        {% if checkout_preview %}
        <div class="checkout-preview">
            <p><strong>Tag #{{ checkout_preview.tag }}</strong> has the following children checked in:</p>
            <ul>
                {% for entry in checkout_preview.details or checkout_preview.children %}
                    {% if entry is mapping %}
                        <li>{{ entry.child }} <span class="guardian-label">â€” Guardian: {{ entry.guardian }}</span></li>
                    {% else %}
                        <li>{{ entry }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
            <form method="post" class="confirm-form">
                <input type="hidden" name="action" value="checkout_confirm">
                <input type="hidden" name="event_id" value="{{ selected_event_id }}">
                <input type="hidden" name="session_day" value="{{ selected_session_date }}">
                <input type="hidden" name="session_id" value="{{ selected_session_id or '' }}">
                <input type="hidden" name="checkout_tag" value="{{ checkout_preview.tag }}">
                <input type="hidden" name="page" value="{{ attendance_pagination.page if attendance_pagination is defined else 1 }}" data-pagination-sync="attendance">
                {% if selected_event_id == 'church-service' %}
                <input type="hidden" name="service_type" value="{{ service_type_default }}">
                {% endif %}
                <button type="submit" class="confirm-btn">Confirm Checkout</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card" style="margin-top: 30px;" data-pagination-container="attendance" data-pagination-current="{{ attendance_pagination.page if attendance_pagination is defined else 1 }}">
    <h3>Today's Log ({{ today_date }})</h3>
    <table>
        <thead>
            <tr>
                <th>Child Name</th>
                <th>Day Tag</th>
                <th>Session / Service</th>
                <th>Campus</th>
                <th>Notes</th>
                <th>Check-in Time</th>
                <th>Check-out Time</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in attendance_today %}
            <tr>
                <td>{{ record['Child Name'] }}</td>
                <td><strong>{{ record['Day Tag'] }}</strong></td>
                <td>
                    {% set period = record.get('Session Period') %}
                    {% if period %}
                        {{ period }} Session
                    {% else %}
                        {{ record.get('Service') or record.get('Session Label') }}
                    {% endif %}<br>
                </td>
                <td>{{ record.get('Church Location') or 'â€”' }}</td>
                <td>{{ record.get('Notes') or 'â€”' }}</td>
                <td>{{ record['Check-in Time'] }}</td>
                <td>{{ record['Check-out Time'] }}</td>
                <td>
                    {% if record['Status'] == 'Checked-Out' %}
                        <span style="color: #dc3545; font-size: 12px; ">ðŸ”´ Checked Out</span>
                    {% else %}
                        <span style="color: #28a745; font-size: 12px; ">ðŸŸ¢ Checked In</span>
                    {% endif %}
                    {% if record.get('sync_status') == 'pending' %}
                        <div style="font-size: 12px; color: #856404;">Pending Sync</div>
                    {% elif record.get('sync_status') == 'failed' %}
                        <div style="font-size: 12px; color: #dc3545;">Sync Failed</div>
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('delete_log', row_id=record.row_id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this entry?');">
                        <input type="hidden" name="data_source" value="{{ record.get('data_source', 'remote') }}">
                        <button type="submit" class="delete-btn">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" style="text-align: center;">No one has been checked in yet today.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if attendance_pagination.show %}
    <nav class="pagination-nav">
        {% if attendance_pagination.has_prev %}
            <a class="page-link" href="{{ attendance_pagination.prev_url }}" aria-label="Previous">&laquo;</a>
        {% endif %}
        {% for item in attendance_pagination.pages %}
            {% if item.ellipsis %}
                <span class="page-ellipsis">&hellip;</span>
            {% else %}
                <a class="page-link{% if item.current %} active{% endif %}" href="{{ item.url }}">{{ item.number }}</a>
            {% endif %}
        {% endfor %}
        {% if attendance_pagination.has_next %}
            <a class="page-link" href="{{ attendance_pagination.next_url }}" aria-label="Next">&raquo;</a>
        {% endif %}
    </nav>
    {% endif %}
    <style>
        .delete-btn { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .context-form { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
        .context-item { display: flex; flex-direction: column; }
        .context-item label { font-size: 13px; margin-bottom: 4px; }
        .session-summary { margin: 12px 0; padding: 10px; background: #f1f3ff; border-radius: 6px; font-size: 13px; }
        .guardian-info { margin: 12px 0; font-size: 13px; color: #555; background: #f8f9fa; padding: 10px; border-radius: 6px; }
        .child-detail-panel { margin: 12px 0; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fdfdfd; }
        .child-detail-head { display: flex; justify-content: space-between; gap: 12px; align-items: flex-start; flex-wrap: wrap; }
        .detail-label { font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.02em; margin: 0 0 4px; }
        .detail-name { margin: 0; font-size: 16px; font-weight: 600; color: #2c2f48; }
        .detail-sub { margin: 4px 0 0; color: #6c757d; font-size: 13px; }
        .detail-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .detail-chip { display: inline-flex; align-items: center; gap: 6px; background: #eef0ff; color: #394170; padding: 6px 10px; border-radius: 20px; font-size: 12px; }
        .note-block { margin-top: 8px; }
        .note-block textarea { width: 100%; resize: vertical; }
        .note-preview { margin-top: 8px; font-size: 13px; color: #555; }
        .checkout-form { display: flex; flex-direction: column; gap: 10px; }
        .find-btn, .confirm-btn { background-color: #5B649F; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }
        .confirm-btn { background-color: #28a745; }
        .find-btn:hover { background-color: #474f85; }
        .confirm-btn:hover { background-color: #1f7a31; }
        .checkout-preview { margin-top: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f9fafc; }
        .checkout-preview ul { margin: 8px 0 0; padding-left: 20px; }
        .guardian-label { color: #555; font-size: 12px; }
        .pagination-nav { display: flex; justify-content: center; gap: 8px; margin-top: 18px; flex-wrap: wrap; }
        .pagination-nav .page-link { display: inline-flex; align-items: center; justify-content: center; min-width: 34px; height: 34px; padding: 0 10px; border: 1px solid #ced4da; border-radius: 4px; color: #495057; text-decoration: none; background: #fff; }
        .pagination-nav .page-link:hover { background: #e9ecef; }
        .pagination-nav .page-link.active { background: #5B649F; color: #fff; border-color: #5B649F; }
        .pagination-nav .page-ellipsis { display: inline-flex; align-items: center; padding: 0 6px; color: #6c757d; }
        .space { margin-right: 20px; }
    </style>
</div>

<!-- ðŸ”¹ Include Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function() {
    $('#child_name').select2({
      placeholder: "Search child...",
      allowClear: true,
      width: '100%'
    });

    const childrenMeta = {{ children_meta|tojson }};

    const stateSelect = document.getElementById('state');
    const churchSelect = document.getElementById('church_location');
    const notesInput = document.getElementById('notes');
    const guardianName = document.getElementById('guardian_name');
    const guardianPhone = document.getElementById('guardian_phone');
    const serviceSelect = document.getElementById('service_type');
    const sessionLabelText = document.getElementById('session_label_text');
    const sessionSelect = document.getElementById('context_session');
    const contextForm = document.querySelector('.context-form');
    const dateInput = document.getElementById('context_date');
    const detailChildName = document.getElementById('detail_child_name');
    const detailChildClass = document.getElementById('detail_child_class');
    const detailChildState = document.getElementById('detail_child_state');
    const detailChildLocation = document.getElementById('detail_child_location');
    const detailChildNote = document.getElementById('detail_child_note');

    if (dateInput && (!dateInput.value || dateInput.value === 'None')) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }

    function setSelectValue(selectEl, value) {
      if (!selectEl) return;
      if (value && !Array.from(selectEl.options).some(opt => opt.value === value)) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectEl.appendChild(option);
      }
      selectEl.value = value || '';
    }

    function updateNotePreview(noteText) {
      if (detailChildNote) {
        detailChildNote.textContent = noteText ? noteText : 'â€”';
      }
    }

    function resetChildDetails() {
      if (detailChildName) detailChildName.textContent = 'Choose a child to view details';
      if (detailChildClass) detailChildClass.textContent = 'Class: â€”';
      if (detailChildState) detailChildState.textContent = 'â€”';
      if (detailChildLocation) detailChildLocation.textContent = 'â€”';
      updateNotePreview('');
      guardianName.textContent = 'â€”';
      guardianPhone.textContent = 'â€”';
      setSelectValue(stateSelect, '');
      setSelectValue(churchSelect, '');
      if (notesInput) notesInput.value = '';
    }

    function applyChildMeta(childName) {
      const meta = childrenMeta[childName] || {};
      setSelectValue(stateSelect, meta.state || '');
      setSelectValue(churchSelect, meta.church_location || '');
      if (notesInput) notesInput.value = meta.notes || '';
      guardianName.textContent = meta.guardian_name || 'â€”';
      guardianPhone.textContent = meta.guardian_phone || 'â€”';
      if (detailChildName) detailChildName.textContent = childName || 'Choose a child to view details';
      if (detailChildClass) detailChildClass.textContent = meta.class_type ? `Class: ${meta.class_type}` : 'Class: â€”';
      if (detailChildState) detailChildState.textContent = meta.state || 'â€”';
      if (detailChildLocation) detailChildLocation.textContent = meta.church_location || 'â€”';
      updateNotePreview(meta.notes || '');
    }

    $('#child_name').on('change', function() {
      const selectedValues = $(this).val() || [];
      const lastSelected = Array.isArray(selectedValues) ? selectedValues[selectedValues.length - 1] : selectedValues;
      if (lastSelected) {
        applyChildMeta(lastSelected);
      } else {
        resetChildDetails();
      }
    });

    if (stateSelect && detailChildState) {
      stateSelect.addEventListener('change', () => {
        detailChildState.textContent = stateSelect.value || 'â€”';
      });
    }

    if (churchSelect && detailChildLocation) {
      churchSelect.addEventListener('change', () => {
        detailChildLocation.textContent = churchSelect.value || 'â€”';
      });
    }

    const preSelectedValues = $('#child_name').val() || [];
    const initialSelection = Array.isArray(preSelectedValues) ? preSelectedValues[preSelectedValues.length - 1] : preSelectedValues;
    if (initialSelection) {
      applyChildMeta(initialSelection);
    } else {
      resetChildDetails();
    }

    if (serviceSelect && sessionLabelText) {
      const updateSessionLabel = () => {
        sessionLabelText.textContent = serviceSelect.value || 'Select a service';
      };
      serviceSelect.addEventListener('change', updateSessionLabel);
      updateSessionLabel();
    }

    if (!serviceSelect && sessionSelect && sessionLabelText) {
      const updateFromSession = () => {
        const option = sessionSelect.options[sessionSelect.selectedIndex];
        if (!option) {
          sessionLabelText.textContent = 'Session';
          return;
        }
        const period = option.dataset.period;
        sessionLabelText.textContent = period ? `${period} Session` : option.text || 'Session';
      };
      sessionSelect.addEventListener('change', updateFromSession);
      updateFromSession();
    }

    if (contextForm) {
      const submitOnChange = element => {
        if (!element) return;
        element.addEventListener('change', () => contextForm.submit());
      };
      submitOnChange(document.getElementById('context_event'));
      submitOnChange(dateInput);
      submitOnChange(sessionSelect);
    }
  });
</script>
<style>
    .check-btn { display: flex; justify-content: flex-end; margin-bottom: 2px; }
    .input-hint { display: block; margin-top: 6px; color: #777; font-size: 12px; }
</style>

{% endblock %}
